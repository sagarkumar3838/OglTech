# RAG (Retrieval-Augmented Generation) Guide

## Overview

This application implements a sophisticated RAG system to reduce AI hallucinations and ensure high-quality, consistent questions. The system combines:

1. **Question Bank**: Curated, verified questions stored in Firestore
2. **Multiple AI Providers**: OpenAI, Anthropic Claude, Google Gemini, Groq, X.AI
3. **Intelligent Fallback**: Automatic provider switching on failure
4. **Hybrid Generation**: Mix of question bank + AI-generated questions

## Why RAG?

### Problems with Pure AI Generation
- **Hallucinations**: AI may generate incorrect or nonsensical questions
- **Inconsistency**: Same prompt produces different quality results
- **Rate Limits**: API quotas can be exceeded with high usage
- **Cost**: Every generation costs money

### RAG Solution
- **Quality Control**: Pre-verified questions ensure accuracy
- **Consistency**: Same questions for same skill/level combinations
- **Cost Effective**: Reduce API calls by using question bank
- **Reliability**: Fallback to question bank if AI fails

## Architecture

```
User Request
     â†“
RAG Service (Strategy Router)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy Selection                â”‚
â”‚  - rag_only: Question Bank only    â”‚
â”‚  - hybrid: Bank + AI (recommended) â”‚
â”‚  - ai_only: AI providers only      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Question Bank (Firestore)         â”‚
â”‚  - Verified questions              â”‚
â”‚  - Skill/Level indexed             â”‚
â”‚  - Similarity search               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Provider Manager               â”‚
â”‚  - Priority-based selection        â”‚
â”‚  - Automatic fallback              â”‚
â”‚  - Round-robin distribution        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Providers (in priority order)  â”‚
â”‚  1. Anthropic Claude               â”‚
â”‚  2. OpenAI GPT-4                   â”‚
â”‚  3. Google Gemini                  â”‚
â”‚  4. Groq (Fast)                    â”‚
â”‚  5. X.AI Grok                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Configuration

### Environment Variables

```env
# RAG Configuration
RAG_ENABLED=true
RAG_STRATEGY=hybrid
RAG_QUESTION_BANK_PERCENTAGE=40
RAG_SIMILARITY_THRESHOLD=0.7

# AI Provider Priority
AI_PROVIDER_PRIORITY=anthropic,openai,google,groq,xai
```

### Strategies

#### 1. `hybrid` (Recommended)
- **Use Case**: Production environments
- **Behavior**: 
  - 40% questions from question bank (configurable)
  - 60% generated by AI
  - AI-generated questions stored in bank for future use
- **Benefits**: Balance between quality and variety

#### 2. `rag_only`
- **Use Case**: Maximum reliability, no AI costs
- **Behavior**: Only uses question bank
- **Benefits**: Zero AI costs, guaranteed quality
- **Limitation**: Limited question variety

#### 3. `ai_only`
- **Use Case**: Maximum variety, testing
- **Behavior**: Only uses AI providers
- **Benefits**: Unlimited question variety
- **Limitation**: Higher costs, potential hallucinations

## AI Providers

### Supported Providers

| Provider | Model | Speed | Cost | Quality |
|----------|-------|-------|------|---------|
| **Anthropic Claude** | claude-3-5-sonnet | Fast | Medium | Excellent |
| **OpenAI** | gpt-4-turbo | Medium | High | Excellent |
| **Google Gemini** | gemini-1.5-pro | Fast | Low | Very Good |
| **Groq** | llama-3.1-70b | Very Fast | Low | Good |
| **X.AI Grok** | grok-beta | Fast | Medium | Good |

### Provider Priority

Set in `.env`:
```env
AI_PROVIDER_PRIORITY=anthropic,openai,google,groq,xai
```

System tries providers in this order. If one fails, automatically falls back to the next.

### Getting API Keys

#### Anthropic Claude
1. Go to https://console.anthropic.com/
2. Sign up / Login
3. API Keys section
4. Create key
5. Copy to `.env`: `ANTHROPIC_API_KEY=sk-ant-...`

#### OpenAI
1. Go to https://platform.openai.com/
2. API Keys section
3. Create key
4. Copy to `.env`: `OPENAI_API_KEY=sk-...`

#### Google Gemini
1. Go to https://makersuite.google.com/app/apikey
2. Create API key
3. Copy to `.env`: `GOOGLE_API_KEY=...`

#### Groq
1. Go to https://console.groq.com/
2. Create API key
3. Copy to `.env`: `GROQ_API_KEY=gsk_...`

#### X.AI (Grok)
1. Go to https://console.x.ai/
2. Create API key
3. Copy to `.env`: `XAI_API_KEY=xai-...`

## Question Bank

### Structure

```typescript
{
  question_id: string;
  skill_area: 'HTML' | 'CSS' | 'JavaScript';
  level: 'BASIC' | 'INTERMEDIATE' | 'ADVANCED';
  type: 'mcq' | 'multi_select' | 'scenario' | 'code_reasoning' | 'assertion_reason';
  question: string;
  options: string[];
  correct_answer: string;
  expected_skills: string[];
  difficulty_weight: number;
  verified: boolean;
  added_at: string;
  created_at: string;
}
```

### Seeding Question Bank

```bash
# Run seed script
npx tsx scripts/seed-question-bank.ts
```

This adds 12 high-quality sample questions covering:
- HTML: Basic, Intermediate, Advanced
- CSS: Basic, Intermediate, Advanced
- JavaScript: Basic, Intermediate, Advanced

### Adding Questions Manually

#### Via Firebase Console
1. Go to Firestore Database
2. Collection: `question_bank`
3. Add document with required fields
4. Set `verified: true` for immediate use

#### Via API (Admin)
```bash
POST /api/admin/question-bank/add
{
  "question_id": "uuid",
  "skill_area": "JavaScript",
  "level": "INTERMEDIATE",
  "type": "mcq",
  "question": "What is a closure?",
  "options": ["A", "B", "C", "D"],
  "correct_answer": "A",
  "expected_skills": ["Closures", "Scope"],
  "difficulty_weight": 7
}
```

### Bulk Import

```bash
POST /api/admin/question-bank/bulk-import
{
  "questions": [
    { /* question 1 */ },
    { /* question 2 */ },
    // ...
  ]
}
```

## Quality Control

### Question Validation

The system automatically validates questions for:
- âœ“ Minimum question length (10 characters)
- âœ“ Sufficient answer options (at least 2)
- âœ“ Correct answer present
- âœ“ No duplicate options
- âœ“ Correct answer in options list
- âœ“ No hallucination indicators

### Hallucination Detection

Questions are rejected if they contain:
- "as an ai"
- "i cannot"
- "i apologize"
- "i don't have"
- "sorry"
- "[insert"
- "example.com"
- "placeholder"

### Verification Workflow

1. AI generates questions
2. Questions stored in `question_bank` with `verified: false`
3. Admin reviews unverified questions
4. Admin verifies good questions via API
5. Verified questions used in future evaluations

## Admin Endpoints

### Get Question Bank Statistics
```bash
GET /api/admin/question-bank/stats

Response:
{
  "total": 50,
  "verified": 45,
  "bySkill": {
    "HTML": 15,
    "CSS": 15,
    "JavaScript": 20
  },
  "byLevel": {
    "BASIC": 15,
    "INTERMEDIATE": 20,
    "ADVANCED": 15
  }
}
```

### Get Unverified Questions
```bash
GET /api/admin/question-bank/unverified

Response:
{
  "questions": [
    { /* unverified question 1 */ },
    { /* unverified question 2 */ }
  ]
}
```

### Verify Question
```bash
POST /api/admin/question-bank/verify/:questionId

Response:
{
  "message": "Question verified successfully"
}
```

### Get AI Provider Status
```bash
GET /api/admin/ai-providers/status

Response:
{
  "providers": {
    "anthropic": { "name": "Anthropic Claude", "available": true },
    "openai": { "name": "OpenAI", "available": true },
    "google": { "name": "Google Gemini", "available": true }
  },
  "priority": ["anthropic", "openai", "google"],
  "total": 3
}
```

## Best Practices

### For Production

1. **Use Hybrid Strategy**
   ```env
   RAG_STRATEGY=hybrid
   RAG_QUESTION_BANK_PERCENTAGE=40
   ```

2. **Configure Multiple Providers**
   - Add at least 2-3 AI provider keys
   - Set priority based on your needs

3. **Seed Question Bank**
   - Run seed script
   - Add custom questions for your domain

4. **Monitor and Verify**
   - Regularly check unverified questions
   - Verify high-quality AI-generated questions

5. **Enable Rate Limiting**
   ```env
   RATE_LIMIT_ENABLED=true
   RATE_LIMIT_MAX_REQUESTS=10
   ```

### For Development

1. **Use AI Only for Testing**
   ```env
   RAG_STRATEGY=ai_only
   ```

2. **Single Provider OK**
   - Just one API key needed for testing

3. **Disable Rate Limiting**
   ```env
   RATE_LIMIT_ENABLED=false
   ```

## Monitoring

### Check System Health

```bash
GET /api/health

Response:
{
  "status": "ok",
  "version": "2.0.0",
  "typescript": true,
  "features": {
    "rag": true,
    "multipleAIProviders": true,
    "rateLimiting": true,
    "questionBank": true
  }
}
```

### Logs

The system logs detailed information:
```
ğŸ¤– AI Provider Manager initialized with 3 provider(s):
   Priority order: anthropic â†’ openai â†’ google

[1/3] Attempting to generate questions with Anthropic Claude...
âœ“ Successfully generated 10 questions with Anthropic Claude in 2341ms

Hybrid generation: 4 from bank, 6 from AI
Stored 6 questions in question bank
```

## Troubleshooting

### Issue: No questions in question bank

**Solution**: Run seed script
```bash
npx tsx scripts/seed-question-bank.ts
```

### Issue: All AI providers failing

**Solution**: 
1. Check API keys are valid
2. Verify API quotas not exceeded
3. Check provider status pages
4. Fall back to `rag_only` strategy

### Issue: Questions are low quality

**Solution**:
1. Increase `RAG_QUESTION_BANK_PERCENTAGE`
2. Review and verify AI-generated questions
3. Add more high-quality questions to bank

### Issue: Rate limit errors

**Solution**:
1. Increase `RATE_LIMIT_MAX_REQUESTS`
2. Use `hybrid` or `rag_only` strategy
3. Add more questions to question bank

## Performance Optimization

### Reduce API Costs

1. **Increase question bank usage**
   ```env
   RAG_QUESTION_BANK_PERCENTAGE=70
   ```

2. **Use faster/cheaper providers**
   ```env
   AI_PROVIDER_PRIORITY=groq,google,anthropic
   ```

3. **Cache AI responses**
   - AI-generated questions automatically stored in bank

### Improve Response Time

1. **Use Groq for speed**
   ```env
   AI_PROVIDER_PRIORITY=groq,google,anthropic,openai
   ```

2. **Increase question bank size**
   - More questions = less AI generation needed

3. **Use `rag_only` for instant responses**
   ```env
   RAG_STRATEGY=rag_only
   ```

## Future Enhancements

- [ ] Vector embeddings for semantic similarity
- [ ] Question difficulty calibration
- [ ] A/B testing different question sets
- [ ] Machine learning for question quality scoring
- [ ] Automatic question generation from documentation
- [ ] Multi-language support

---

**RAG System Status: âœ… Production Ready**

The system is designed to handle high loads, multiple failures, and ensure consistent quality while minimizing costs.
